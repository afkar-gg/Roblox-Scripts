--[[
    This script runs on the server once to create the entire UI for players.
    It should be placed in ServerScriptService.
]]

-- Define the parent for the UI
local starterGui = game:GetService("StarterGui")

-- Prevent the UI from being created multiple times during testing in Studio
if starterGui:FindFirstChild("JokiControlUI") then
    print("JokiControlUI already exists. Skipping creation.")
    return
end

-- STEP 1: Create the ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "JokiControlUI"
screenGui.ResetOnSpawn = true -- Ensures the UI reloads if the character respawns

-- STEP 2: Create the TextBox
local durationInputBox = Instance.new("TextBox")
durationInputBox.Name = "DurationInputBox"
durationInputBox.Parent = screenGui
durationInputBox.Size = UDim2.new(0, 300, 0, 50)
durationInputBox.Position = UDim2.fromScale(0.5, 0.4) -- Position relative to screen size
durationInputBox.AnchorPoint = Vector2.new(0.5, 0.5) -- Center the UI element
durationInputBox.PlaceholderText = "Enter hours for joki (e.g., 3)"
durationInputBox.TextScaled = true
durationInputBox.ClearTextOnFocus = false
durationInputBox.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
durationInputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
durationInputBox.BorderColor3 = Color3.fromRGB(80, 80, 80)
durationInputBox.BorderSizePixel = 2

-- STEP 3: Create the TextButton
local sendButton = Instance.new("TextButton")
sendButton.Name = "SendButton"
sendButton.Parent = screenGui
sendButton.Size = UDim2.new(0, 300, 0, 60)
sendButton.Position = UDim2.fromScale(0.5, 0.55) -- Position it below the textbox
sendButton.AnchorPoint = Vector2.new(0.5, 0.5)
sendButton.Text = "Start Joki & Send Notification"
sendButton.TextScaled = true
sendButton.BackgroundColor3 = Color3.fromRGB(0, 170, 81) -- A nice green
sendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
sendButton.Font = Enum.Font.SourceSansBold

-- STEP 4: Create the LocalScript and embed the code within it
local localScript = Instance.new("LocalScript")
localScript.Name = "ControlScript"
localScript.Parent = screenGui

-- The code for the LocalScript is stored in this multi-line string
localScript.Source = [[
    --// Services
    local Players = game:GetService("Players")
    local HttpService = game:GetService("HttpService")

    --// UI Elements
    local gui = script:FindFirstAncestorOfClass("ScreenGui")
    if not gui then
        warn("ERROR: This LocalScript is NOT inside a ScreenGui.")
        return
    end
    local durationInputBox = gui:WaitForChild("DurationInputBox")
    local sendButton = gui:WaitForChild("SendButton")

    --// Player Info
    local LocalPlayer = Players.LocalPlayer
    local username = LocalPlayer.Name

    --// Static Configuration
    local url = "https://discord.com/api/webhooks/1379133678566768670/FoESNZDajE2aq8i00v1cedlbqk6NGsYim83bdIIVynkY4q877RzDyRpWUdrVjvOE_xY8"
    local no_order = "OD000000141403135"
    local new_string = string.sub(no_order, 9)

    --// Reusable Function to Send the Embed
    function SendMessageEMBED(embed)
        pcall(function()
            local data = { ["embeds"] = { embed } }
            local body = HttpService:JSONEncode(data)
            local success, response = pcall(function()
                HttpService:PostAsync(url, body, Enum.HttpContentType.ApplicationJson)
            end)
            if success then
                print("Webhook sent successfully!")
                sendButton.Text = "Notification Sent!"
            else
                warn("Failed to send webhook:", response)
                sendButton.Text = "Error! Try Again."
            end
            task.wait(3)
            sendButton.Text = "Start Joki & Send Notification"
        end)
    end

    --// Main Logic: Runs when the button is clicked
    sendButton.MouseButton1Click:Connect(function()
        print("Button clicked. Preparing to send notification.")
        sendButton.Text = "Sending..."
        local jam_selesai_joki = tonumber(durationInputBox.Text)

        if not jam_selesai_joki or jam_selesai_joki <= 0 then
            warn("Invalid input detected. Defaulting to 1 hour.")
            jam_selesai_joki = 1
        end

        local current_time = os.time()
        local wib = current_time + 25200
        local done_joki = wib + (3600 * jam_selesai_joki)

        local embed_to_send = {
            ["title"] = "JOKI DIMULAI",
            ["description"] = "Username : " .. username,
            ["color"] = 65280,
            ["fields"] = {
                {
                    ["name"] = "Info Order",
                    ["value"] = "Nomor Order : " .. no_order .. "\nLink [Riwayat pesanan](https://tokoku.itemku.com/riwayat-pesanan/rincian/" .. new_string .. ")",
                    ["inline"] = false
                },
                {
                    ["name"] = "Info Joki (" .. jam_selesai_joki .. " jam)",
                    ["value"] = "Waktu mulai : " .. os.date("!*t", wib).day .. "/" .. os.date("!*t", wib).month .. " " .. os.date("%H:%M:%S", wib) .. "\nWaktu selesai : " .. os.date("!*t", done_joki).day .. "/" .. os.date("!*t", done_joki).month .. " " .. os.date("%H:%M:%S", done_joki),
                    ["inline"] = false
                }
            },
            ["footer"] = { ["text"] = "- afkarstore ❤️" }
        }
        SendMessageEMBED(embed_to_send)
    end)
]]

-- Final step: Parent the completed ScreenGui to StarterGui
screenGui.Parent = starterGui

print("JokiControlUI created successfully in StarterGui.")

